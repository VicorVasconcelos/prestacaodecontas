<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prestação de Contas</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      background: white;
      max-width: 900px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    .content {
      padding: 40px;
    }
    
    .info-box {
      background: #f0f7ff;
      border-left: 4px solid #2a5298;
      padding: 16px 20px;
      margin-bottom: 30px;
      border-radius: 6px;
    }
    
    .info-box p {
      color: #1e3c72;
      line-height: 1.6;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2a5298;
      font-size: 15px;
    }
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #FF6B35;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    
    input[type="file"] {
      padding: 10px;
      cursor: pointer;
    }
    
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    #status {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      display: none;
    }
    
    #status.show {
      display: block;
    }
    
    #status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    #status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    #status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #FF6B35;
      padding: 16px 20px;
      margin-bottom: 30px;
      border-radius: 6px;
      display: none;
    }
    
    .warning-box.show {
      display: block;
    }
    
    .warning-box p {
      color: #856404;
      line-height: 1.6;
      font-size: 14px;
      margin: 0;
    }
    
    .warning-box strong {
      color: #FF6B35;
    }
    
    #fileCount {
      margin-top: 8px;
      color: #2a5298;
      font-size: 14px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 24px;
      }
      
      .content {
        padding: 30px 20px;
      }
      
      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Prestação de Contas</h1>
    </div>
    
    <div class="content">
      <div class="form-group">
        <label>Nome Completo:</label>
        <input id="nomeCompleto" placeholder="Ex: João da Silva Santos" />
      </div>

      <div class="form-group">
        <label>E-mail:</label>
        <input id="email" type="email" placeholder="Ex: joao.silva@email.com" />
      </div>

      <div class="row">
        <div class="form-group">
          <label>UF (Estado):</label>
          <select id="uf">
            <option value="">Selecione o Estado</option>
            <option value="AC">AC - Acre</option>
            <option value="AL">AL - Alagoas</option>
            <option value="AP">AP - Amapá</option>
            <option value="AM">AM - Amazonas</option>
            <option value="BA">BA - Bahia</option>
            <option value="CE">CE - Ceará</option>
            <option value="DF">DF - Distrito Federal</option>
            <option value="ES">ES - Espírito Santo</option>
            <option value="GO">GO - Goiás</option>
            <option value="MA">MA - Maranhão</option>
            <option value="MT">MT - Mato Grosso</option>
            <option value="MS">MS - Mato Grosso do Sul</option>
            <option value="MG">MG - Minas Gerais</option>
            <option value="PA">PA - Pará</option>
            <option value="PB">PB - Paraíba</option>
            <option value="PR">PR - Paraná</option>
            <option value="PE">PE - Pernambuco</option>
            <option value="PI">PI - Piauí</option>
            <option value="RJ">RJ - Rio de Janeiro</option>
            <option value="RN">RN - Rio Grande do Norte</option>
            <option value="RS">RS - Rio Grande do Sul</option>
            <option value="RO">RO - Rondônia</option>
            <option value="RR">RR - Roraima</option>
            <option value="SC">SC - Santa Catarina</option>
            <option value="SP">SP - São Paulo</option>
            <option value="SE">SE - Sergipe</option>
            <option value="TO">TO - Tocantins</option>
          </select>
        </div>
        <div class="form-group">
          <label>Município:</label>
          <input id="municipio" placeholder="Ex: São Paulo" />
        </div>
      </div>

      <div class="form-group">
        <label>Projeto:</label>
        <select id="projeto">
          <option value="ENEM">ENEM</option>
          <option value="ENADE">ENADE</option>
        </select>
      </div>

      <div class="row">
        <div class="form-group">
          <label>N° da Coordenação:</label>
          <input id="evento" placeholder="Ex: 25" />
        </div>
        <div class="form-group">
          <label>CPF (somente números):</label>
          <input id="cpf" placeholder="Ex: 35404973587" />
        </div>
        <div class="form-group">
          <label>Tipo do Kit:</label>
          <select id="kit">
            <option value="KLI">KLI - Kit Limpeza</option>
            <option value="KLA">KLA - Kit Lanche</option>
            <option value="AJC">AJC - Apoio Logístico</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Valor da Nota (R$):</label>
        <input id="valorNota" type="number" step="0.01" min="0" placeholder="Ex: 150.00" />
      </div>

      <div class="form-group">
        <label>Tipo de Arquivo:</label>
        <select id="tipoArquivo">
          <option value="">Selecione o tipo de arquivo</option>
          <option value="Nota Fiscal">Nota Fiscal</option>
          <option value="Recibo">Recibo</option>
          <option value="Nota Fiscal e Recibo">Nota Fiscal e Recibo</option>
          <option value="Cupom Fiscal">Cupom Fiscal</option>
          <option value="Valor Devolvido para o CEBRASPE">Valor Devolvido para o CEBRASPE</option>
        </select>
      </div>

      <div class="form-group">
        <label>Selecione os arquivos (múltiplos arquivos permitidos):</label>
        <input id="files" type="file" multiple accept="image/*,.pdf" onchange="updateFileCount()" />
        <div id="fileCount"></div>
      </div>

      <button onclick="enviar()">Enviar Arquivos</button>

      <div id="status"></div>
    </div>
  </div>

<script>
function updateFileCount() {
  const files = document.getElementById("files").files;
  const fileCount = document.getElementById("fileCount");
  
  if(files.length > 0) {
    fileCount.innerHTML = `✓ ${files.length} arquivo(s) selecionado(s)`;
  } else {
    fileCount.innerHTML = "";
  }
}

async function enviar(){
  // ID fixo da pasta do Google Drive
  const folderId = "1_iUe4TwHF9B-9CjHcpUirbDlOZlOv_Ko";

  const nomeCompleto = document.getElementById("nomeCompleto").value.trim();
  const email = document.getElementById("email").value.trim();
  const uf = document.getElementById("uf").value;
  const municipio = document.getElementById("municipio").value.trim();
  const projeto = document.getElementById("projeto").value;
  const evento = document.getElementById("evento").value.trim();
  const cpf = document.getElementById("cpf").value.trim();
  const kit = document.getElementById("kit").value;
  const valorNota = document.getElementById("valorNota").value.trim();
  const tipoArquivo = document.getElementById("tipoArquivo").value;
  const files = document.getElementById("files").files;

  if(!nomeCompleto || !email || !uf || !municipio || !evento || !cpf || !valorNota || !tipoArquivo || files.length===0){
    alert("Preencha todos os campos obrigatórios e selecione ao menos um arquivo.");
    return;
  }

  let status = document.getElementById("status");
  status.className = "show loading";
  status.innerHTML = "Enviando arquivos...";

  // Converter para base64
  let fileList = [];
  for(let i=0;i<files.length;i++){
    const file = files[i];
    const base64 = await toBase64(file);
    fileList.push({
      name: file.name,
      type: file.type,
      data: base64.split(",")[1]
    });
  }

  const payload = {
    folderId,
    nomeCompleto,
    email,
    uf,
    municipio,
    projeto,
    evento,
    cpf,
    kit,
    valorNota,
    tipoArquivo,
    files: fileList
  };

  // Enviar ao Google Apps Script
  fetch("https://script.google.com/macros/s/AKfycbx_Zqbq51IJXPo_qa0drUmvY4p_3KpTre9zLHk7x7oWn__PGWnLLercDZKd57oUNIOKSA/exec",{
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="ok"){
      status.className = "show success";
      status.innerHTML = "✓ Arquivos enviados com sucesso!";
    } else if(res.status==="duplicate" || res.status==="exists"){
      // Backend detectou arquivo existente - pedir confirmação
      const confirmar = confirm(
        "⚠️ ATENÇÃO: Já existem arquivos enviados com estes dados (CPF: " + cpf + ", Coordenação: " + evento + ").\n\n" +
        "Os novos arquivos irão SOBREPOR os arquivos anteriores.\n\n" +
        "Deseja continuar e substituir os arquivos?"
      );
      
      if(confirmar) {
        // Reenviar com flag de confirmação
        enviarComConfirmacao(folderId, projeto, evento, cpf, kit, valorNota, files);
      } else {
        status.className = "show error";
        status.innerHTML = "✗ Envio cancelado pelo usuário.";
      }
    } else {
      status.className = "show error";
      status.innerHTML = "✗ Erro: " + JSON.stringify(res);
    }
  })
  .catch(err=>{
    status.className = "show error";
    status.innerHTML = "✗ Falha na conexão: " + err;
  });
}

async function enviarComConfirmacao(folderId, projeto, evento, cpf, kit, valorNota, files) {
  let status = document.getElementById("status");
  status.className = "show loading";
  status.innerHTML = "Sobrepondo arquivos...";

  const nomeCompleto = document.getElementById("nomeCompleto").value.trim();
  const email = document.getElementById("email").value.trim();
  const uf = document.getElementById("uf").value;
  const municipio = document.getElementById("municipio").value.trim();
  const tipoArquivo = document.getElementById("tipoArquivo").value;

  // Converter para base64
  let fileList = [];
  for(let i=0;i<files.length;i++){
    const file = files[i];
    const base64 = await toBase64(file);
    fileList.push({
      name: file.name,
      type: file.type,
      data: base64.split(",")[1]
    });
  }

  const payload = {
    folderId,
    nomeCompleto,
    email,
    uf,
    municipio,
    projeto,
    evento,
    cpf,
    kit,
    valorNota,
    tipoArquivo,
    files: fileList,
    forceOverwrite: true  // Flag para backend confirmar sobrescrita
  };

  fetch("https://script.google.com/macros/s/AKfycbx_Zqbq51IJXPo_qa0drUmvY4p_3KpTre9zLHk7x7oWn__PGWnLLercDZKd57oUNIOKSA/exec",{
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="ok"){
      status.className = "show success";
      status.innerHTML = "✓ Arquivos sobrescritos com sucesso!";
    } else {
      status.className = "show error";
      status.innerHTML = "✗ Erro ao sobrescrever: " + JSON.stringify(res);
    }
  })
  .catch(err=>{
    status.className = "show error";
    status.innerHTML = "✗ Falha na conexão: " + err;
  });
}

function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=>resolve(reader.result);
    reader.onerror = err=>reject(err);
  });
}
</script>

</body>
</html>
